#!/bin/bash

set -euo pipefail

# exports the rclone.conf out of the KeePass Database

RCLONE_CONF_DEST="$HOME/.config/rclone/rclone.conf"
KEEPASS_FILE="$HOME/.data/keepass/PwdDatenbank.kdbx"
KEEPASS_ENTRY="/linux-config/rclone.conf"

# copy rclone.conf out of KEEPASS_FILE to RCLONE_CONF_DEST
[ -f  $RCLONE_CONF_DEST ] && cp $RCLONE_CONF_DEST "$RCLONE_CONF_DEST.backup"

read -sp "Bitte Passwort zum Entsperren der Datenbank eingeben: " PW
echo "";

while [[ ! $( echo "$PW" | keepassxc-cli attachment-export  $KEEPASS_FILE $KEEPASS_ENTRY rclone.conf $RCLONE_CONF_DEST ) ]]
do
    echo "";
    echo "Falsches Passwort, bitte erneut eingeben.";
    read -sp "Bitte Passwort zum Entsperren der Datenbank eingeben: " PW
    echo "";
done